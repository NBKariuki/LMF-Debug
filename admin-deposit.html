<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <title>MMF Â· Log Deposit</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:      #0a0a0f;
            --card:    #13131c;
            --border:  rgba(255,255,255,0.07);
            --border2: rgba(255,255,255,0.12);
            --accent:  #00e5a0;
            --ad:      rgba(0,229,160,0.1);
            --blue:    #60a5fa;
            --bd:      rgba(96,165,250,0.1);
            --gold:    #fbbf24;
            --red:     #f87171;
            --rd:      rgba(248,113,113,0.1);
            --t1:      #f0f0f8;
            --t2:      rgba(240,240,248,0.5);
            --t3:      rgba(240,240,248,0.25);
            --r:       12px;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body {
            font-family: 'Sora', sans-serif;
            background: var(--bg); color: var(--t1);
            min-height: 100svh; padding-bottom: 48px;
            background-image: radial-gradient(ellipse 80% 35% at 50% 0%, rgba(0,229,160,0.05) 0%, transparent 60%);
        }
        .header { padding:20px 18px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--border); }
        .hicon  { width:38px; height:38px; border-radius:11px; flex-shrink:0; background:linear-gradient(135deg,#00e5a0,#60a5fa); display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
        .htitle { font-size:1rem; font-weight:800; }
        .hsub   { font-size:0.68rem; color:var(--t3); margin-top:1px; }

        #lockScreen { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:80svh; padding:0 24px; }
        .lock-emoji { font-size:2.6rem; margin-bottom:14px; }
        .lock-title { font-size:1.3rem; font-weight:800; margin-bottom:4px; }
        .lock-sub   { font-size:0.78rem; color:var(--t2); margin-bottom:28px; }
        .pin-row    { display:flex; gap:8px; width:100%; max-width:320px; }
        .pin-input  { flex:1; background:var(--card); border:1px solid var(--border2); border-radius:var(--r); color:var(--t1); font-family:'JetBrains Mono',monospace; font-size:1.4rem; letter-spacing:0.3em; text-align:center; padding:14px; outline:none; -webkit-appearance:none; }
        .pin-input:focus { border-color:var(--accent); }
        .pin-btn  { padding:14px 20px; background:var(--accent); color:#0a0a0f; border:none; border-radius:var(--r); font-family:'Sora',sans-serif; font-weight:800; font-size:0.9rem; cursor:pointer; }
        .pin-err  { color:var(--red); font-size:0.75rem; margin-top:8px; text-align:center; min-height:18px; }

        #mainForm { display:none; padding:0 18px; }
        .slabel   { font-size:0.58rem; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:var(--t3); margin:20px 0 7px; }

        .paste-wrap { position:relative; }
        .paste-box  { width:100%; min-height:90px; background:var(--card); border:1px solid var(--border2); border-radius:var(--r); color:var(--t1); font-family:'Sora',sans-serif; font-size:0.82rem; line-height:1.6; padding:12px 14px; resize:none; outline:none; -webkit-appearance:none; transition:border-color .2s; }
        .paste-box:focus { border-color:var(--accent); }
        .paste-box::placeholder { color:var(--t3); font-size:0.78rem; }
        .parse-btn { position:absolute; bottom:10px; right:10px; background:var(--accent); color:#0a0a0f; border:none; border-radius:8px; font-family:'Sora',sans-serif; font-size:0.72rem; font-weight:700; padding:6px 12px; cursor:pointer; }

        .extracted { display:none; margin-top:8px; background:var(--ad); border:1px solid rgba(0,229,160,0.2); border-radius:var(--r); padding:10px 14px; font-size:0.78rem; line-height:1.8; }
        .extracted.show { display:block; }
        .ex-row   { display:flex; justify-content:space-between; align-items:center; }
        .ex-label { color:var(--t3); font-size:0.7rem; }
        .ex-val   { font-family:'JetBrains Mono',monospace; font-weight:600; color:var(--accent); }
        .ex-warn  { color:var(--gold); font-size:0.72rem; margin-top:6px; }

        .igroup { position:relative; margin-bottom:8px; }
        .iicon  { position:absolute; left:13px; top:50%; transform:translateY(-50%); font-size:0.95rem; pointer-events:none; color:var(--t3); z-index:2; }
        input[type=text], input[type=number], input[type=date], select { width:100%; background:var(--card); border:1px solid var(--border2); border-radius:var(--r); color:var(--t1); font-family:'Sora',sans-serif; font-size:0.9rem; font-weight:500; padding:13px 13px 13px 40px; outline:none; -webkit-appearance:none; transition:border-color .2s; }
        input:focus, select:focus { border-color:var(--accent); }
        input::placeholder { color:var(--t3); }
        select option { background:#1a1a26; }
        .mono-input   { font-family:'JetBrains Mono',monospace; font-size:1rem; font-weight:600; letter-spacing:0.06em; text-transform:uppercase; }
        .amount-input { font-family:'JetBrains Mono',monospace; font-size:1.15rem; font-weight:600; padding-left:56px; }
        .kes-prefix   { position:absolute; left:13px; top:50%; transform:translateY(-50%); font-family:'JetBrains Mono',monospace; font-size:0.7rem; font-weight:700; color:var(--accent); z-index:2; letter-spacing:.06em; }

        .method-row { display:flex; gap:8px; margin-bottom:8px; }
        .mbtn { flex:1; padding:11px 6px; background:var(--card); border:1px solid var(--border2); border-radius:var(--r); color:var(--t2); font-family:'Sora',sans-serif; font-size:0.78rem; font-weight:700; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:3px; transition:all .18s; }
        .mbtn .mi { font-size:1.2rem; }
        .mbtn.active { background:var(--ad); border-color:var(--accent); color:var(--accent); }

        .credit-toggle { display:flex; margin-bottom:12px; border-radius:var(--r); overflow:hidden; border:1px solid var(--border2); }
        .ctbtn { flex:1; padding:11px; background:var(--card); border:none; color:var(--t2); font-family:'Sora',sans-serif; font-size:0.8rem; font-weight:700; cursor:pointer; transition:all .18s; border-right:1px solid var(--border2); }
        .ctbtn:last-child { border-right:none; }
        .ctbtn.active { background:var(--ad); color:var(--accent); }

        #splitCredit { display:none; }
        .split-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
        .split-alias { flex:1; }
        .split-alias select { padding:11px 11px 11px 36px; font-size:0.85rem; }
        .split-alias .iicon { font-size:0.8rem; }
        .split-amt { width:130px; flex-shrink:0; }
        .split-amt input { padding:11px 11px 11px 46px; font-size:0.9rem; font-family:'JetBrains Mono',monospace; font-weight:600; }
        .split-amt .kes-prefix { font-size:0.65rem; }
        .split-del { width:34px; height:34px; flex-shrink:0; background:var(--rd); border:none; border-radius:8px; color:var(--red); font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .add-split-btn { width:100%; padding:10px; background:transparent; border:1px dashed rgba(255,255,255,0.15); border-radius:var(--r); color:var(--t3); font-family:'Sora',sans-serif; font-size:0.8rem; font-weight:600; cursor:pointer; margin-top:2px; transition:all .18s; }

        .balance-bar { margin-top:10px; padding:10px 14px; background:var(--card); border-radius:var(--r); border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .bal-label { font-size:0.72rem; color:var(--t3); }
        .bal-val   { font-family:'JetBrains Mono',monospace; font-size:0.95rem; font-weight:600; }
        .bal-ok    { color:var(--accent); }
        .bal-over  { color:var(--red); }
        .bal-under { color:var(--gold); }

        textarea.notes-box { width:100%; background:var(--card); border:1px solid var(--border2); border-radius:var(--r); color:var(--t1); font-family:'Sora',sans-serif; font-size:0.82rem; line-height:1.6; padding:12px 14px; resize:none; outline:none; height:72px; -webkit-appearance:none; transition:border-color .2s; }
        textarea.notes-box:focus { border-color:var(--accent); }

        .submit-btn { width:100%; padding:16px; margin-top:20px; background:var(--accent); color:#0a0a0f; border:none; border-radius:var(--r); font-family:'Sora',sans-serif; font-size:1rem; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all .2s; }
        .submit-btn:disabled { background:rgba(0,229,160,0.25); color:rgba(10,10,15,.4); cursor:not-allowed; }
        .submit-btn:not(:disabled):active { transform:scale(0.98); }

        .status { display:none; margin-top:12px; padding:13px 15px; border-radius:var(--r); font-size:0.82rem; line-height:1.6; white-space:pre-line; text-align:center; }
        .status.ok   { display:block; background:var(--ad); border:1px solid rgba(0,229,160,.25); color:var(--accent); }
        .status.err  { display:block; background:var(--rd); border:1px solid rgba(248,113,113,.25); color:var(--red); }
        .status.wait { display:block; background:rgba(255,255,255,.03); border:1px solid var(--border); color:var(--t2); }

        .log-head  { display:flex; justify-content:space-between; align-items:center; margin-top:28px; margin-bottom:10px; }
        .log-title { font-size:0.58rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--t3); }
        .log-count { font-size:0.65rem; color:var(--t3); background:rgba(255,255,255,.05); padding:3px 9px; border-radius:20px; }
        .log-entry { background:var(--card); border:1px solid var(--border); border-radius:var(--r); padding:11px 13px; margin-bottom:7px; }
        .log-top   { display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; }
        .log-alias { font-size:0.85rem; font-weight:700; }
        .log-amt   { font-family:'JetBrains Mono',monospace; font-size:0.88rem; font-weight:600; color:var(--accent); }
        .log-meta  { font-size:0.68rem; color:var(--t3); }
        .badge     { display:inline-block; font-size:0.58rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; padding:2px 7px; border-radius:20px; margin-left:5px; }
        .badge-m   { background:var(--ad); color:var(--accent); }
        .badge-b   { background:var(--bd); color:var(--blue); }
        .badge-s   { background:rgba(251,191,36,.1); color:var(--gold); }
        .empty-log { color:var(--t3); font-size:0.75rem; text-align:center; padding:14px 0; }

        @keyframes spin { to { transform:rotate(360deg); } }
        .spin { width:17px; height:17px; border:2.5px solid rgba(10,10,15,.25); border-top-color:#0a0a0f; border-radius:50%; animation:spin .65s linear infinite; }
        .divider { height:1px; background:var(--border); margin:22px 0; }
    </style>
</head>
<body>

<div class="header">
    <div class="hicon">ğŸ’°</div>
    <div>
        <div class="htitle">MMF Â· Deposit Log</div>
        <div class="hsub">Admin only Â· Private</div>
    </div>
</div>

<!-- LOCK SCREEN -->
<div id="lockScreen">
    <div class="lock-emoji">ğŸ”</div>
    <div class="lock-title">Admin Access</div>
    <div class="lock-sub">Enter your PIN to continue</div>
    <div class="pin-row">
        <input class="pin-input" type="password" id="pinInput"
               placeholder="â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" autocomplete="off">
        <button class="pin-btn" onclick="checkPin()">Go</button>
    </div>
    <div class="pin-err" id="pinErr"></div>
</div>

<!-- MAIN FORM -->
<div id="mainForm">

    <div class="slabel">â‘  Paste M-PESA Message</div>
    <div class="paste-wrap">
        <textarea class="paste-box" id="msgBox" rows="4"
            placeholder="Paste the forwarded M-PESA SMS hereâ€¦&#10;&#10;e.g. UAKES4BCMP Confirmed. Ksh6,000.00 sent to ETICA CAPITAL LTD for account 308398M on 20/1/26 at 2:26 PMâ€¦"></textarea>
        <button class="parse-btn" onclick="parseMessage()">Extract âœ¨</button>
    </div>
    <div class="extracted" id="extracted">
        <div class="ex-row"><span class="ex-label">Code</span>   <span class="ex-val" id="exCode">â€”</span></div>
        <div class="ex-row"><span class="ex-label">Amount</span> <span class="ex-val" id="exAmt">â€”</span></div>
        <div class="ex-row"><span class="ex-label">Date</span>   <span class="ex-val" id="exDate">â€”</span></div>
        <div class="ex-row"><span class="ex-label">Account</span><span class="ex-val" id="exAcct">â€”</span></div>
        <div class="ex-warn" id="exWarn"></div>
    </div>

    <div class="slabel">â‘¡ Payment Method</div>
    <div class="method-row">
        <button class="mbtn active" id="btnM" onclick="setMethod('MPESA')"><span class="mi">ğŸ“±</span>M-PESA</button>
        <button class="mbtn"        id="btnB" onclick="setMethod('BANK')"><span class="mi">ğŸ¦</span>Bank</button>
    </div>

    <div class="slabel">â‘¢ Received From</div>
    <div class="igroup">
        <span class="iicon">ğŸ‘¤</span>
        <select id="fromMember">
            <option value="" disabled selected>Who made this deposit?</option>
            <option>Tokyo</option><option>Berlin</option><option>Gandia</option>
            <option>Denver</option><option>Helsinki</option><option>Oslo</option>
            <option>Moscow</option><option>California</option><option>Lisbon</option>
            <option>Stockholm</option><option>Paris</option><option>Marseille</option>
            <option>Rio</option><option>Nairobi</option><option>Tel Aviv</option>
            <option>Valencia</option><option>Havana</option><option>Manilla</option>
            <option>Scofield</option><option>Bogota</option><option>Emirates</option>
            <option>Dublin</option><option>Doha</option><option>Bern</option>
        </select>
    </div>

    <div class="slabel">â‘£ Amount, Date & Code</div>
    <div class="igroup">
        <span class="kes-prefix">KES</span>
        <input type="number" class="amount-input" id="totalAmount" placeholder="0" min="1" inputmode="decimal">
    </div>
    <div class="igroup">
        <span class="iicon">ğŸ“…</span>
        <input type="date" id="depositDate">
    </div>
    <div class="igroup">
        <span class="iicon">ğŸ”‘</span>
        <input type="text" class="mono-input" id="refCode"
               placeholder="e.g. UAKES4BCMP" maxlength="20"
               autocapitalize="characters" autocomplete="off">
    </div>

    <div class="slabel">â‘¤ Credit To</div>
    <div class="credit-toggle">
        <button class="ctbtn active" id="ctSingle" onclick="setCreditMode('single')">ğŸ‘¤ Single Member</button>
        <button class="ctbtn"        id="ctSplit"  onclick="setCreditMode('split')">ğŸ”€ Split</button>
    </div>

    <div id="singleCredit">
        <div class="igroup">
            <span class="iicon">ğŸ¯</span>
            <select id="creditMember">
                <option value="" disabled selected>Select member to credit</option>
                <option>Tokyo</option><option>Berlin</option><option>Gandia</option>
                <option>Denver</option><option>Helsinki</option><option>Oslo</option>
                <option>Moscow</option><option>California</option><option>Lisbon</option>
                <option>Stockholm</option><option>Paris</option><option>Marseille</option>
                <option>Rio</option><option>Nairobi</option><option>Tel Aviv</option>
                <option>Valencia</option><option>Havana</option><option>Manilla</option>
                <option>Scofield</option><option>Bogota</option><option>Emirates</option>
                <option>Dublin</option><option>Doha</option><option>Bern</option>
            </select>
        </div>
    </div>

    <div id="splitCredit">
        <div id="splitRows"></div>
        <button class="add-split-btn" onclick="addSplitRow()">ï¼‹ Add Member</button>
        <div class="balance-bar">
            <span class="bal-label">Unallocated</span>
            <span class="bal-val" id="balVal">â€”</span>
        </div>
    </div>

    <div class="slabel">â‘¥ Notes <span style="color:var(--t3);font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></div>
    <textarea class="notes-box" id="notes" placeholder="e.g. Member's second deposit this weekâ€¦"></textarea>

    <button class="submit-btn" id="submitBtn" onclick="submitDeposit()">
        <span id="submitLabel">Log Deposit</span>
    </button>
    <div class="status" id="statusBox"></div>

    <div class="divider"></div>

    <div class="log-head">
        <div class="log-title">Recent Entries</div>
        <div class="log-count" id="logCount">0 this session</div>
    </div>
    <div id="recentLog"></div>
    <div class="empty-log" id="emptyLog">No entries logged yet this session</div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG  â€” two separate PINs, two separate jobs
//
//  ADMIN_PIN  = UI gate only. Readable in page source â€” that's OK.
//               Anyone who finds it can open the form, nothing more.
//
//  SERVER_PIN = Sent inside every payload. Server checks it and
//               rejects / logs / rate-limits if it doesn't match.
//               Even if someone extracts ADMIN_PIN from source and
//               posts directly to the Apps Script URL, they still
//               need this PIN or every attempt is logged + blocked.
//
//  Change SERVER_PIN here to match the SERVER_PIN in deposit-logger.gs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ADMIN_PIN       = '1234';
var SERVER_PIN      = '4040';
var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqEfsYI_8AKAlYfuUyzoiYbLRYXTQJVYgVygEXysGlwE5cMwQVDcsdI_c9LyYJOLXy/exec';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var payMethod  = 'MPESA';
var creditMode = 'single';
var splitCount = 0;
var sessionLog = [];

// Stable per-device token â€” shows up in Audit Log so you can
// identify which device made a submission
var CLIENT_TOKEN = (function() {
    try {
        var t = localStorage.getItem('mmf_tok');
        if (!t) { t = 'tok_' + Math.random().toString(36).slice(2,10); localStorage.setItem('mmf_tok', t); }
        return t;
    } catch(e) { return 'tok_' + Math.random().toString(36).slice(2,10); }
})();
var DEVICE_INFO = (navigator.userAgent || 'unknown').slice(0, 80);

var MEMBERS = [
    'Tokyo','Berlin','Gandia','Denver','Helsinki','Oslo','Moscow',
    'California','Lisbon','Stockholm','Paris','Marseille','Rio',
    'Nairobi','Tel Aviv','Valencia','Havana','Manilla','Scofield',
    'Bogota','Emirates','Dublin','Doha','Bern'
];

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
    setToday();
    document.getElementById('pinInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') checkPin();
    });
    document.getElementById('refCode').addEventListener('input', function() {
        var p = this.selectionStart;
        this.value = this.value.toUpperCase();
        this.setSelectionRange(p, p);
    });
    document.getElementById('totalAmount').addEventListener('input', updateBalance);
    addSplitRow(); addSplitRow();
});

function setToday() {
    var d = new Date();
    document.getElementById('depositDate').value =
        d.getFullYear() + '-' +
        String(d.getMonth()+1).padStart(2,'0') + '-' +
        String(d.getDate()).padStart(2,'0');
}

// â”€â”€ LOCK SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkPin() {
    if (document.getElementById('pinInput').value.trim() === ADMIN_PIN) {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('mainForm').style.display   = 'block';
    } else {
        document.getElementById('pinErr').textContent = 'âŒ Wrong PIN';
        document.getElementById('pinInput').value = '';
        document.getElementById('pinInput').focus();
        setTimeout(function() { document.getElementById('pinErr').textContent = ''; }, 2200);
    }
}

// â”€â”€ M-PESA PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseMessage() {
    var msg  = document.getElementById('msgBox').value.trim();
    var el   = document.getElementById('extracted');
    var warn = document.getElementById('exWarn');
    warn.textContent = '';
    if (!msg) { showStatus('err','Paste an M-PESA message first.'); return; }

    var codeM = msg.match(/^([A-Z0-9]{10})\s+Confirmed/i);
    var amtM  = msg.match(/Ksh([\d,]+(?:\.\d+)?)\s+sent/i);
    var dateM = msg.match(/on\s+(\d{1,2})\/(\d{1,2})\/(\d{2,4})/i);
    var acctM = msg.match(/for account\s+(\S+)/i);

    if (!codeM && !amtM) {
        warn.textContent = 'âš ï¸ Could not read this message. Check format.';
        el.classList.add('show'); return;
    }
    if (codeM) {
        document.getElementById('refCode').value      = codeM[1];
        document.getElementById('exCode').textContent = codeM[1];
    }
    if (amtM) {
        var amt = Math.round(parseFloat(amtM[1].replace(/,/g,'')));
        document.getElementById('totalAmount').value   = amt;
        document.getElementById('exAmt').textContent   = 'KES ' + amt.toLocaleString();
        updateBalance();
    }
    if (dateM) {
        var yr = parseInt(dateM[3]); if (yr < 100) yr += 2000;
        var iso = yr + '-' + String(dateM[2]).padStart(2,'0') + '-' + String(dateM[1]).padStart(2,'0');
        document.getElementById('depositDate').value  = iso;
        document.getElementById('exDate').textContent = new Date(iso).toLocaleDateString('en-KE',{day:'numeric',month:'short',year:'numeric'});
    } else {
        document.getElementById('exDate').textContent = 'Not found â€” using today';
        warn.textContent = 'âš ï¸ Date not found â€” confirm date below.';
    }
    document.getElementById('exAcct').textContent = acctM ? acctM[1] : 'â€”';
    el.classList.add('show');
    setMethod('MPESA');
    setTimeout(function() { document.getElementById('fromMember').focus(); }, 300);
}

// â”€â”€ METHOD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMethod(m) {
    payMethod = m;
    document.getElementById('btnM').classList.toggle('active', m==='MPESA');
    document.getElementById('btnB').classList.toggle('active', m==='BANK');
}

// â”€â”€ CREDIT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setCreditMode(mode) {
    creditMode = mode;
    document.getElementById('ctSingle').classList.toggle('active', mode==='single');
    document.getElementById('ctSplit').classList.toggle('active',  mode==='split');
    document.getElementById('singleCredit').style.display = mode==='single' ? 'block' : 'none';
    document.getElementById('splitCredit').style.display  = mode==='split'  ? 'block' : 'none';
    updateBalance();
}

// â”€â”€ SPLIT ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addSplitRow() {
    splitCount++;
    var id  = 'split_' + splitCount;
    var div = document.createElement('div');
    div.className = 'split-row'; div.id = id;
    div.innerHTML =
        '<div class="split-alias igroup" style="margin-bottom:0">' +
            '<span class="iicon">ğŸ‘¤</span>' +
            '<select class="split-sel" onchange="updateBalance()">' +
                '<option value="" disabled selected>Member</option>' +
                MEMBERS.map(function(m){ return '<option>' + m + '</option>'; }).join('') +
            '</select>' +
        '</div>' +
        '<div class="split-amt igroup" style="margin-bottom:0">' +
            '<span class="kes-prefix">KES</span>' +
            '<input type="number" class="split-amt-input" placeholder="0" min="0" inputmode="decimal" oninput="updateBalance()">' +
        '</div>' +
        '<button class="split-del" onclick="removeSplitRow(\'' + id + '\')" title="Remove">âœ•</button>';
    document.getElementById('splitRows').appendChild(div);
    updateBalance();
}
function removeSplitRow(id) {
    var el = document.getElementById(id); if (el) el.remove(); updateBalance();
}

// â”€â”€ BALANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateBalance() {
    if (creditMode !== 'split') return;
    var total = parseFloat(document.getElementById('totalAmount').value) || 0;
    var alloc = 0;
    document.querySelectorAll('.split-amt-input').forEach(function(i){ alloc += parseFloat(i.value)||0; });
    var rem = total - alloc;
    var el  = document.getElementById('balVal');
    el.textContent = (rem===0?'âœ… ':'') + 'KES ' + Math.abs(rem).toLocaleString() +
                     (rem>0?' remaining':rem<0?' over!':' â€” balanced');
    el.className = 'bal-val ' + (rem===0?'bal-ok':rem<0?'bal-over':'bal-under');
}

// â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SERVER_PIN travels inside the JSON body â€” never in a URL or header.
// The server (deposit-logger.gs) checks it before doing anything else.
// Wrong PIN â†’ logged in Audit Log, form shows error.
// Correct PIN â†’ logged in Audit Log as DEPOSIT, written to sheets.
function submitDeposit() {
    var from   = document.getElementById('fromMember').value;
    var amount = parseFloat(document.getElementById('totalAmount').value);
    var code   = document.getElementById('refCode').value.trim().toUpperCase();
    var date   = document.getElementById('depositDate').value;
    var notes  = document.getElementById('notes').value.trim();

    if (!from)               return showStatus('err','Select who made the deposit.');
    if (!amount || amount<=0) return showStatus('err','Enter the deposit amount.');
    if (!code)               return showStatus('err','Enter the reference code.');
    if (!date)               return showStatus('err','Confirm the deposit date.');

    var credits = [];
    if (creditMode === 'single') {
        var to = document.getElementById('creditMember').value;
        if (!to) return showStatus('err','Select a member to credit.');
        credits = [{ alias: to, amount: amount }];
    } else {
        document.querySelectorAll('.split-row').forEach(function(row) {
            var alias = row.querySelector('.split-sel').value;
            var amt   = parseFloat(row.querySelector('.split-amt-input').value) || 0;
            if (alias && amt > 0) credits.push({ alias: alias, amount: amt });
        });
        if (credits.length === 0) return showStatus('err','Add at least one member to the split.');
        var splitTotal = credits.reduce(function(s,c){ return s+c.amount; }, 0);
        if (Math.abs(splitTotal - amount) > 0.01)
            return showStatus('err','Split total (KES ' + splitTotal.toLocaleString() + ') doesn\'t match deposit (KES ' + amount.toLocaleString() + ').');
    }

    var btn = document.getElementById('submitBtn');
    var lbl = document.getElementById('submitLabel');
    btn.disabled = true;
    lbl.innerHTML = '<div class="spin"></div> Loggingâ€¦';
    showStatus('wait','Sending to Google Sheetsâ€¦');

    var payload = {
        pin:         SERVER_PIN,   // server validates this â€” not stored in sheet
        clientToken: CLIENT_TOKEN, // audit trail
        device:      DEVICE_INFO,  // audit trail
        timestamp:   new Date().toISOString(),
        date:        date,
        week:        weekNum(new Date(date)),
        from:        from,
        method:      payMethod,
        totalAmount: amount,
        refCode:     code,
        notes:       notes,
        credits:     credits,
        isSplit:     creditMode === 'split'
    };

    var xhr = new XMLHttpRequest();
    xhr.open('POST', APPS_SCRIPT_URL, true);
    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onreadystatechange = function() {
        if (xhr.readyState !== 4) return;
        // Try to read a JSON response (only available in same-origin or if CORS is open)
        try {
            var r = JSON.parse(xhr.responseText);
            if (r.status === 'wrong_pin') {
                showStatus('err','âŒ Wrong server PIN.\nCheck SERVER_PIN in the HTML matches deposit-logger.gs');
                btn.disabled = false; lbl.textContent = 'Log Deposit'; return;
            }
            if (r.status === 'blocked') {
                showStatus('err','ğŸ”’ Too many failed attempts.\nTry again in 30 minutes.');
                btn.disabled = false; lbl.textContent = 'Log Deposit'; return;
            }
            if (r.status === 'error') {
                showStatus('err','âš ï¸ Server error: ' + (r.message || 'unknown'));
                btn.disabled = false; lbl.textContent = 'Log Deposit'; return;
            }
        } catch(e) { /* opaque no-cors response â€” server still received it */ }
        onSuccess(payload);
    };

    // Apps Script no-cors redirects fire onerror in XHR â€” treat as success
    xhr.onerror = function() { onSuccess(payload); };

    try {
        xhr.send(JSON.stringify(payload));
    } catch(e) {
        showStatus('err','âŒ Send failed: ' + e.message);
        btn.disabled = false; lbl.textContent = 'Log Deposit';
    }
}

function onSuccess(payload) {
    var desc = payload.isSplit
        ? payload.credits.map(function(c){ return c.alias+' KES '+c.amount.toLocaleString(); }).join(', ')
        : payload.credits[0].alias;
    showStatus('ok','âœ… Logged!\n'+payload.refCode+' Â· KES '+payload.totalAmount.toLocaleString()+'\nFrom: '+payload.from+' â†’ '+desc);
    sessionLog.unshift(payload);
    renderLog();
    // reset
    ['fromMember','totalAmount','refCode','notes','msgBox','creditMember'].forEach(function(id){
        document.getElementById(id).value = '';
    });
    document.getElementById('extracted').classList.remove('show');
    document.querySelectorAll('.split-amt-input').forEach(function(i){ i.value=''; });
    document.querySelectorAll('.split-sel').forEach(function(s){ s.selectedIndex=0; });
    updateBalance();
    btn_reset();
    window.scrollTo({top:0,behavior:'smooth'});
}
function btn_reset() {
    document.getElementById('submitBtn').disabled  = false;
    document.getElementById('submitLabel').textContent = 'Log Deposit';
}

// â”€â”€ RECENT LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLog() {
    var container = document.getElementById('recentLog');
    var empty     = document.getElementById('emptyLog');
    document.getElementById('logCount').textContent = sessionLog.length + ' this session';
    if (!sessionLog.length) { empty.style.display='block'; container.innerHTML=''; return; }
    empty.style.display = 'none';
    container.innerHTML = sessionLog.slice(0,10).map(function(e) {
        var badge = e.isSplit ? '<span class="badge badge-s">SPLIT</span>' : '<span class="badge badge-m">'+e.method+'</span>';
        var lines = e.credits.map(function(c){
            return '<span style="color:var(--t2)">'+c.alias+'</span> <span style="color:var(--accent);font-family:\'JetBrains Mono\',monospace;font-size:.8rem">+'+c.amount.toLocaleString()+'</span>';
        }).join(' &nbsp;Â·&nbsp; ');
        return '<div class="log-entry"><div class="log-top"><div class="log-alias">'+e.from+' '+badge+'</div><div class="log-amt">KES '+e.totalAmount.toLocaleString()+'</div></div><div class="log-meta">'+e.date+' Â· '+e.refCode+' Â· Credit: '+lines+'</div></div>';
    }).join('');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showStatus(type, msg) {
    var el = document.getElementById('statusBox');
    el.className = 'status ' + type; el.textContent = msg;
}
function weekNum(d) {
    var date = new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
    var day  = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate()+4-day);
    var y = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    return 'W'+Math.ceil((((date-y)/86400000)+1)/7);
}
</script>
</body>
</html>
